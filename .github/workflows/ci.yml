name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 6am UTC to catch YouTube API changes
    - cron: '0 6 * * *'

env:
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1

jobs:
  # Fast unit tests - no network, runs first
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/test_unit.py tests/test_new_modules.py -v --cov=. --cov-report=xml

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unit
          fail_ci_if_error: false

  # E2E tests - real YouTube API calls
  e2e-tests:
    runs-on: ubuntu-latest
    needs: unit-tests  # Only run if unit tests pass

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.11-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov

      - name: Run e2e tests
        run: |
          pytest tests/test_e2e.py -v --cov=. --cov-report=xml -x
        continue-on-error: true  # YouTube rate limiting may cause failures

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: e2e
          fail_ci_if_error: false

  # PDF generation tests
  pdf-tests:
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies for PDF
        run: |
          sudo apt-get update
          sudo apt-get install -y libpango-1.0-0 libcairo2 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest weasyprint

      - name: Test PDF generation
        run: |
          python -c "
          from create_epub import create_ebook
          import tempfile
          import os

          articles = [{
              'title': 'PDF Test Article',
              'channel': 'Test Channel',
              'article': '# Test\\n\\nThis is a test article for PDF generation.\\n\\n## Section\\n\\nMore content here.'
          }]

          with tempfile.TemporaryDirectory() as tmpdir:
              output = os.path.join(tmpdir, 'test.pdf')
              result = create_ebook(articles, output_path=output, format='pdf')
              assert result is not None, 'PDF creation failed'
              assert os.path.exists(result), 'PDF file not created'
              size = os.path.getsize(result)
              assert size > 1000, f'PDF too small: {size} bytes'
              print(f'PDF created successfully: {size} bytes')
          "

  # CLI tests - verify commands work
  cli-tests:
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Test CLI help
        run: |
          readtube --help
          readtube-batch --help || true
          readtube-write --help || true

      - name: Test LLM backends list
        run: |
          python llm.py --list-backends

      - name: Test fetch transcript (may fail due to rate limiting)
        run: |
          python fetch_transcript.py --help
          # Try a real fetch - may be rate limited
          timeout 30 python fetch_transcript.py "https://www.youtube.com/watch?v=dQw4w9WgXcQ" || echo "Fetch skipped (rate limited or timeout)"

  # Lint and type check
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff
        run: |
          ruff check . --select=E9,F63,F7,F82 --statistics
          ruff check . --exit-zero --statistics

  # Security scan
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install safety
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Check dependencies for vulnerabilities
        run: |
          pip install -r requirements.txt
          safety check || true  # Don't fail on vulnerabilities, just report

      - name: Run bandit security scan
        run: |
          bandit -r . -x ./tests --skip B101,B311 -f txt || true

  # Build package
  build:
    runs-on: ubuntu-latest
    needs: [unit-tests, lint]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Check package
        run: |
          twine check dist/*

      - name: Test package installation
        run: |
          pip install dist/*.whl
          python -c "import fetch_transcript; import create_epub; import llm; print('Package imports OK')"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # Full integration test
  integration:
    runs-on: ubuntu-latest
    needs: [unit-tests, pdf-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpango-1.0-0 libcairo2 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info

      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov weasyprint pyyaml

      - name: Run full test suite
        run: |
          pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=xml
        continue-on-error: true  # Some tests may fail due to rate limiting

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: integration
          fail_ci_if_error: false

      - name: Test EPUB creation
        run: |
          python -c "
          from create_epub import create_ebook
          import tempfile
          import os

          articles = [{
              'title': 'Integration Test',
              'channel': 'CI Pipeline',
              'url': 'https://example.com',
              'article': '# Integration Test\\n\\nThis verifies the full pipeline works.\\n\\n## Features\\n\\n- EPUB generation\\n- Markdown parsing\\n- Typography'
          }]

          with tempfile.TemporaryDirectory() as tmpdir:
              # Test EPUB
              epub_path = os.path.join(tmpdir, 'test.epub')
              result = create_ebook(articles, output_path=epub_path, format='epub')
              assert os.path.exists(result), 'EPUB not created'
              print(f'EPUB: {os.path.getsize(result)} bytes')

              # Test HTML
              html_path = os.path.join(tmpdir, 'test.html')
              result = create_ebook(articles, output_path=html_path, format='html')
              assert os.path.exists(result), 'HTML not created'
              print(f'HTML: {os.path.getsize(result)} bytes')

              # Test PDF
              pdf_path = os.path.join(tmpdir, 'test.pdf')
              result = create_ebook(articles, output_path=pdf_path, format='pdf')
              assert os.path.exists(result), 'PDF not created'
              print(f'PDF: {os.path.getsize(result)} bytes')

              print('All formats generated successfully!')
          "

      - name: Test RSS generation
        run: |
          python -c "
          from rss import generate_rss_feed, generate_atom_feed

          articles = [
              {'title': 'Article 1', 'channel': 'Ch1', 'url': 'https://example.com/1', 'article': 'Content 1'},
              {'title': 'Article 2', 'channel': 'Ch2', 'url': 'https://example.com/2', 'article': 'Content 2'},
          ]

          rss = generate_rss_feed(articles, title='Test Feed')
          assert '<?xml' in rss
          assert 'Article 1' in rss
          print('RSS feed generated OK')

          atom = generate_atom_feed(articles, title='Test Feed')
          assert '<?xml' in atom
          assert 'Article 1' in atom
          print('Atom feed generated OK')
          "
